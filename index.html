<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>yasiii susiii</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #05010a;
            --bg-secondary: #12051c;
            --bubble-me: #5a1c8a;
            --bubble-emon: #1f0b33;
            --text-primary: #f5e8ff;
            --text-secondary: #c5aaf5;
            --border-color: #3b1b52;
            --input-bg: #10041b;
            --accent: #a855f7;
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
        }

        body {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: radial-gradient(circle at top, rgba(168, 85, 247, 0.15), transparent 45%), var(--bg-primary);
            color: var(--text-primary);
        }

        .chat-container {
            width: 100vw;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: transparent;
        }

        .chat-header {
            background: rgba(8, 2, 18, 0.8);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 1.25rem 1rem;
            text-align: center;
            z-index: 30;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(12px);
        }

        .profile-link {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s ease;
            display: inline-flex;
            align-items: center;
        }

        .profile-link:hover {
            color: var(--text-primary);
        }

        .chat-box {
            flex: 1;
            padding: 1rem;
            padding-bottom: calc(1rem + 6rem + env(safe-area-inset-bottom, 0));
            overflow-y: auto;
            scroll-behavior: smooth;
            background: linear-gradient(180deg, rgba(21, 7, 37, 0.8), rgba(5, 1, 10, 0.95));
        }

        .message {
            max-width: 75%;
            margin: 0.5rem 0;
            padding: 0.85rem 1.15rem;
            border-radius: 1.5rem;
            clear: both;
            word-wrap: break-word;
            position: relative;
            white-space: pre-wrap;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            user-select: none;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
        }

        .me {
            background: var(--bubble-me);
            color: var(--text-primary);
            margin-left: auto;
            border-bottom-right-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .emon {
            background: var(--bubble-emon);
            color: var(--text-primary);
            margin-right: auto;
            border-bottom-left-radius: 0.5rem;
            border: 1px solid rgba(168, 85, 247, 0.15);
        }

        .message:hover {
            transform: translateY(-1px);
            background-color: rgba(255, 255, 255, 0.05);
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0.85;
            margin-top: 0.5rem;
            float: right;
            margin-left: 1rem;
        }

        .media {
            display: block;
            max-width: 100%;
            border-radius: 1rem;
            margin: 0;
            cursor: pointer;
            object-fit: cover;
            transition: opacity 0.2s ease;
            box-shadow: 0 5px 30px rgba(168, 85, 247, 0.25);
        }

        .message .media + .message-text-content {
            margin-top: 0.75rem;
        }

        .media:hover {
            opacity: 0.85;
        }

        .media-video {
            display: block;
            width: 100%;
            max-height: 280px;
            border-radius: 1rem;
            margin: 0;
        }

        .media-audio {
            width: 100%;
            height: 40px;
            border-radius: 20px;
            margin-top: 0.25rem;
            outline: none;
        }

        .input-box {
            position: fixed;
            left: 0;
            right: 0;
            bottom: env(safe-area-inset-bottom, 0);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background: rgba(5, 1, 10, 0.95);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 50;
            backdrop-filter: blur(16px);
        }

        .input-content-wrapper {
            display: flex;
            align-items: flex-end;
            width: 100%;
            max-width: 800px;
            gap: 0.75rem;
        }

        .input-area-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            gap: 0.5rem;
        }

        .message-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--input-bg);
            border-radius: 2rem;
            border: 1px solid var(--border-color);
            min-height: 3rem;
            transition: border-color 0.3s ease;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
            padding-right: 0.5rem;
        }

        .message-input-wrapper:focus-within {
            border-color: var(--accent);
        }

        .message-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            outline: none;
            resize: none;
            max-height: 8rem;
            color: var(--text-primary);
            font-family: inherit;
        }

        .message-input::placeholder {
            color: var(--text-secondary);
        }

        .send-button, .plus-button, .emoji-button {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .emoji-button {
            font-size: 1.5rem;
        }

        .send-button {
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            color: white;
            border: none;
        }

        .plus-button, .emoji-button {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .send-button:hover:not(:disabled), .plus-button:hover, .emoji-button:hover {
            opacity: 0.85;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        /* Microphone Button */
        .mic-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            font-size: 1.2rem;
            transition: color 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .mic-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* Recording Interface */
        .recording-ui {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--input-bg);
            z-index: 60;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            border-radius: 0;
            backdrop-filter: blur(10px);
        }

        .recording-ui.active {
            display: flex;
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #ef4444;
            font-weight: 600;
            font-family: monospace;
            font-size: 1.1rem;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
            animation: pulse-red 1.2s infinite;
        }

        @keyframes pulse-red {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .recording-actions {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .rec-action-btn {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: transform 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rec-cancel { color: #ef4444; }
        .rec-send { color: var(--accent); }
        
        .rec-action-btn:hover { transform: scale(1.15); }

        .file-info-bar {
            display: none;
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--input-bg);
            border-radius: 1rem;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
        }

        .file-info-bar.show {
            display: flex;
        }

        #sentNotification {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background: rgba(15, 3, 24, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 2rem;
            color: var(--text-primary);
            font-weight: 600;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.6s ease;
            opacity: 0;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.45);
        }

        #sentNotification.show {
            top: 2rem;
            opacity: 1;
        }

        .load-more {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 1.5rem;
            margin: 1rem auto;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .load-more:hover {
            background: var(--bg-secondary);
        }

        .modal-container {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(3, 0, 7, 0.95);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.65);
        }

        .close-modal-btn {
            position: absolute;
            top: 1rem;
            right: 2rem;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background: rgba(15, 3, 24, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal-btn:hover {
            background: #ef4444;
        }

        .date-separator span {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .chat-box::-webkit-scrollbar {
            width: 4px;
        }

        .chat-box::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-box::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .chat-box::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .file-message {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .file-message:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .file-icon {
            font-size: 1.5rem;
            margin-right: 0.75rem;
            color: var(--text-primary);
        }

        .reply-preview {
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            background: rgba(168, 85, 247, 0.12);
            display: flex;
            gap: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .reply-bar {
            width: 2px;
            background-color: var(--accent);
            border-radius: 1px;
            flex-shrink: 0;
        }

        .message.emon .reply-bar {
            background-color: var(--text-secondary);
        }

        .reply-content {
            font-size: 0.8rem;
            line-height: 1.2;
            overflow: hidden;
        }

        .reply-sender {
            font-weight: 600;
            color: var(--accent);
        }

        .message.emon .reply-sender {
            color: var(--text-primary);
        }

        .reply-text {
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reactions-container {
            position: absolute;
            bottom: -0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.25rem;
            background: rgba(16, 4, 27, 0.9);
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
            transform: scale(0);
            transition: transform 0.3s ease;
            transform-origin: bottom right;
            z-index: 10;
        }

        .message.me .reactions-container {
            right: auto;
            left: 0.75rem;
            transform-origin: bottom left;
        }

        .reactions-container.visible {
            transform: scale(1);
        }

        .reaction-pill {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
        }

        #messageActionMenu {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .context-action-btn {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            width: 100%;
            text-align: left;
            color: var(--text-primary);
            transition: background-color 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .context-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        #quickReactions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }

        .reaction-emoji {
            flex-shrink: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.5rem;
            transition: transform 0.2s ease;
        }

        .reaction-emoji:hover {
            transform: scale(1.25);
        }

        .expand-toggle-btn {
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .expand-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.1);
        }

        #expandedReactionsPanel {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(2.5rem, 1fr));
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        #expandedReactionsPanel.show {
            display: grid !important;
        }

        #expandedReactionsPanel::-webkit-scrollbar {
            width: 4px;
        }

        #expandedReactionsPanel::-webkit-scrollbar-track {
            background: transparent;
        }

        #expandedReactionsPanel::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .message {
                max-width: 85%;
                padding: 0.875rem 1rem;
            }

            .chat-header {
                padding: 1rem 0.75rem;
            }

            .input-box {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <h3 class="font-bold text-xl tracking-wide mb-1">Emon</h3>
        <a href="https://emoneditz.github.io/about-me/" target="_blank" class="profile-link">
            <i class="fas fa-user-circle mr-1"></i> View Profile
        </a>
    </div>

    <div class="chat-box" id="chatBox">
        <div class="load-more" id="loadMore" style="display: none;">
            <i class="fas fa-arrow-up mr-2"></i>Load older messages
        </div>
    </div>

    <div id="sentNotification">
        <i id="sentIcon" class="fas fa-check-circle text-green-500"></i>
        <span id="sentMessage">Message sent!</span>
    </div>

    <div class="input-box" id="inputBox">
        <!-- Recording UI Overlay -->
        <div class="recording-ui" id="recordingUI">
            <div class="recording-indicator">
                <div class="recording-dot"></div>
                <span id="recordTimer">00:00</span>
            </div>
            <div class="recording-actions">
                <button class="rec-action-btn rec-cancel" id="cancelRecBtn" title="Cancel">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="rec-action-btn rec-send" id="sendRecBtn" title="Send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <input type="file" id="fileInput" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.txt">
        <div class="input-content-wrapper">
            <div class="input-area-container">
                 <div id="replyingToBar" class="file-info-bar">
                    <div class="file-details flex items-center flex-1 overflow-hidden">
                        <i class="fas fa-reply file-icon"></i>
                        <div class="flex flex-col flex-1 overflow-hidden">
                             <span id="replyingToUser" class="file-name text-white font-medium truncate flex-1"></span>
                             <span id="replyingToText" class="text-gray-300 text-xs truncate"></span>
                        </div>
                    </div>
                    <button id="replyCloseBtn" class="file-close-btn text-gray-400 hover:text-red-400 ml-3 p-1" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="fileInfoBar" class="file-info-bar">
                    <div class="file-details flex items-center flex-1 overflow-hidden">
                        <i id="fileIcon" class="file-icon"></i>
                        <span id="fileName" class="file-name text-white font-medium truncate flex-1"></span>
                        <span id="fileSize" class="file-size text-gray-300 text-xs ml-2 flex-shrink-0"></span>
                    </div>
                    <button id="fileCloseBtn" class="file-close-btn text-gray-400 hover:text-red-400 ml-3 p-1" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="message-input-wrapper">
                    <button type="button" class="plus-button" onclick="openFileDialog()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <textarea id="msg" class="message-input" placeholder="Type a message..." rows="1"></textarea>
                    <button type="button" class="mic-btn" id="startRecBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>
            <button type="button" class="send-button" onclick="sendMessage()" id="sendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<div class="modal-container" id="modalContainer">
    <span class="close-modal-btn" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="fullImage" src="" alt="Full size image">
</div>

<div id="messageActionMenu" class="hidden absolute z-[101]">
    <div id="quickReactions" class="flex items-center gap-1 p-2 mb-2" style="background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 2rem;">
    </div>
    <div id="expandedReactionsPanel" class="hidden" style="background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; margin-bottom: 0.5rem; max-height: 200px; overflow-y: auto;">
    </div>
    <div class="flex flex-col gap-1 p-1" style="background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem;">
        <button id="replyBtn" class="context-action-btn">
            <i class="fas fa-reply w-5 mr-2 text-gray-300"></i>
            <span>Reply</span>
        </button>
        <button id="copyBtn" class="context-action-btn">
            <i class="fas fa-copy w-5 mr-2 text-gray-300"></i>
            <span>Copy</span>
        </button>
        <button id="deleteBtn" class="context-action-btn">
            <i class="fas fa-trash w-5 mr-2 text-gray-300"></i>
            <span>Delete</span>
        </button>
    </div>
</div>

<script>
    const TOKEN = "7576622210:AAE9evjkyhHtGPU1Ox0s-Iivo3hlfD_Jny8";
    const CHAT_ID = "6009819572";
    const EMON_ID = 6009819572;
    const chatBox = document.getElementById('chatBox');
    const loadMoreBtn = document.getElementById('loadMore');
    const modalContainer = document.getElementById('modalContainer');
    const fullImage = document.getElementById('fullImage');
    const fileInput = document.getElementById('fileInput');
    const fileInfoBar = document.getElementById('fileInfoBar');
    const fileNameDisplay = document.getElementById('fileName');
    const fileSizeDisplay = document.getElementById('fileSize');
    const fileIconDisplay = document.getElementById('fileIcon');
    const fileCloseBtn = document.getElementById('fileCloseBtn');
    const messageInput = document.getElementById('msg');
    const sendBtn = document.getElementById('sendBtn');
    const sentNotification = document.getElementById('sentNotification');
    const sentMessage = document.getElementById('sentMessage');
    const sentIcon = document.getElementById('sentIcon');

    const messageActionMenu = document.getElementById('messageActionMenu');
    const quickReactions = document.getElementById('quickReactions');
    const expandedReactionsPanel = document.getElementById('expandedReactionsPanel');
    const replyBtn = document.getElementById('replyBtn');
    const copyBtn = document.getElementById('copyBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const replyingToBar = document.getElementById('replyingToBar');
    const replyingToUser = document.getElementById('replyingToUser');
    const replyingToText = document.getElementById('replyingToText');
    const replyCloseBtn = document.getElementById('replyCloseBtn');

    // Voice Recording Elements
    const recordingUI = document.getElementById('recordingUI');
    const recordTimer = document.getElementById('recordTimer');
    const startRecBtn = document.getElementById('startRecBtn');
    const cancelRecBtn = document.getElementById('cancelRecBtn');
    const sendRecBtn = document.getElementById('sendRecBtn');
    
    let mediaRecorder;
    let audioChunks = [];
    let recordStartTime;
    let recordInterval;
    let shouldSendRecording = false;

    let chatHistory = [];
    let historyOffset = 0;
    let isLoadingHistory = false;
    let lastUpdateId = 0;
    let initialLoadComplete = false;

    let activeMessageElement = null;
    let activeReplyMessage = null;
    let emojiUsage = {};

    function loadEmojiUsage() {
        try {
            const stored = localStorage.getItem('emojiUsage');
            if (stored) emojiUsage = JSON.parse(stored);
        } catch (e) { console.error(e); }
    }

    function saveEmojiUsage() {
        localStorage.setItem('emojiUsage', JSON.stringify(emojiUsage));
    }

    const allReactions = [
        'â¤ï¸', 'ðŸ¤·â€â™€ï¸', 'ðŸ˜', 'ðŸ˜­', 'ðŸ‘', 'ðŸ¤£', 'ðŸ‘Ž', 'ðŸ«¡',
        'ðŸ’”', 'ðŸ˜‡', 'ðŸŒš', 'ðŸ¥°', 'ðŸ˜¡', 'ðŸ¥´', 'ðŸ¤”', 'ðŸ¤¨',
        'ðŸ¤“', 'ðŸ–•', 'ðŸ˜', 'ðŸ¤¡', 'ðŸ¤', 'ðŸ™', 'ðŸ“', 'ðŸ”¥',
        'ðŸ‘', 'ðŸ¤¯', 'ðŸ˜±', 'ðŸ¤¬', 'ðŸ˜¢', 'ðŸŽ‰', 'ðŸ¤©', 'ðŸ¤®',
        'ðŸ’©', 'ðŸ‘Œ', 'ðŸ•Šï¸', 'ðŸ¥±', 'ðŸ˜', 'ðŸ³', 'â¤ï¸â€ðŸ”¥', 'ðŸŒ­',
        'ðŸ’¯', 'âš¡', 'ðŸŒ', 'ðŸ†', 'ðŸ¾', 'ðŸ’‹', 'ðŸ˜ˆ', 'ðŸ˜´',
        'ðŸ‘»', 'ðŸ§‘â€ðŸ’»', 'ðŸ‘€', 'ðŸŽƒ', 'ðŸ™ˆ', 'ðŸ˜¨', 'âœï¸', 'ðŸ¤—',
        'ðŸŽ…', 'ðŸŽ„', 'â˜ƒï¸', 'ðŸ’…', 'ðŸ¤ª', 'ðŸ—¿', 'ðŸ†’', 'ðŸ’˜',
        'ðŸ™‰', 'ðŸ¦„', 'ðŸ˜˜', 'ðŸ’Š', 'ðŸ™Š', 'ðŸ˜Ž', 'ðŸ‘¾', 'ðŸ¤·â€â™‚ï¸'
    ];

    function loadChatHistory() {
        const storedHistory = localStorage.getItem('chatHistory');
        if (storedHistory) {
            chatHistory = JSON.parse(storedHistory);
        }
        displayRecentMessages(20);
    }

    function saveChatHistory() {
        if (chatHistory.length > 50) {
            chatHistory = chatHistory.slice(chatHistory.length - 50);
        }
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    }

    function displayRecentMessages(count = 20) {
        const recentMessages = chatHistory.slice(-count);
        let currentDate = '';
        chatBox.innerHTML = '';
        recentMessages.forEach(msg => {
            const messageDate = new Date(msg.timestamp).toDateString();
            if (messageDate !== currentDate) {
                addDateSeparator(messageDate, true);
                currentDate = messageDate;
            }
            displayMessage(msg, false);
        });
        chatBox.insertAdjacentElement('afterbegin', loadMoreBtn);
        if (chatHistory.length > count) {
            loadMoreBtn.style.display = 'block';
            historyOffset = count;
        } else {
            loadMoreBtn.style.display = 'none';
        }
        initialLoadComplete = true;
        setTimeout(() => scrollToBottom(), 100);
    }

    function addDateSeparator(dateStr, append = false) {
        const separator = document.createElement('div');
        separator.classList.add('date-separator', 'text-center', 'my-4', 'relative');
        separator.innerHTML = `<span>${dateStr}</span>`;
        if (append) {
            chatBox.appendChild(separator);
        } else {
            chatBox.insertBefore(separator, loadMoreBtn.nextSibling);
        }
    }

    function loadOlderMessages() {
        if (isLoadingHistory || historyOffset >= chatHistory.length) return;
        isLoadingHistory = true;
        loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
        setTimeout(() => {
            const oldScrollHeight = chatBox.scrollHeight;
            const messagesToLoad = 20;
            const startIndex = Math.max(0, chatHistory.length - historyOffset - messagesToLoad);
            const endIndex = chatHistory.length - historyOffset;
            if (startIndex < endIndex) {
                const olderMessages = chatHistory.slice(startIndex, endIndex);
                let lastDate = new Date(olderMessages[olderMessages.length-1].timestamp).toDateString();
                olderMessages.reverse().forEach(msg => {
                    const messageDate = new Date(msg.timestamp).toDateString();
                    if(messageDate !== lastDate) {
                        addDateSeparator(lastDate, false);
                        lastDate = messageDate;
                    }
                    displayMessage(msg, true);
                });
                historyOffset += messagesToLoad;
                chatBox.scrollTop = chatBox.scrollHeight - oldScrollHeight;
            }
            if (historyOffset >= chatHistory.length)
                loadMoreBtn.style.display = 'none';
            loadMoreBtn.innerHTML = '<i class="fas fa-arrow-up mr-2"></i>Load older messages';
            isLoadingHistory = false;
        }, 800);
    }

    function showSentStatus(message, type = 'success') {
        sentMessage.textContent = message;
        sentIcon.className = type === 'success' ? 'fas fa-check-circle text-green-500' : 'fas fa-exclamation-circle text-red-500';
        sentNotification.classList.add('show');
        setTimeout(() => {
            sentNotification.classList.remove('show');
        }, 3000);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileIcon(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        const icons = {
            pdf: 'fa-solid fa-file-pdf', docx: 'fa-solid fa-file-word', txt: 'fa-solid fa-file-lines',
            jpg: 'fa-solid fa-image', jpeg: 'fa-solid fa-image', png: 'fa-solid fa-image', gif: 'fa-solid fa-image',
            mp4: 'fa-solid fa-file-video', mov: 'fa-solid fa-file-video',
            mp3: 'fa-solid fa-file-audio',
            zip: 'fa-solid fa-file-zipper'
        };
        return icons[ext] || 'fa-solid fa-file';
    }

    function displayMessage(messageData, prepend = false) {
        const existingMsgDiv = document.querySelector(`div[data-message-id='${messageData.id}']`);
        if (existingMsgDiv) existingMsgDiv.remove();
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', messageData.sender);
        msgDiv.dataset.messageId = messageData.id;
        if (messageData.replyTo) {
            const originalMessage = chatHistory.find(m => m.id === messageData.replyTo);
            if (originalMessage) {
                const replyPreview = document.createElement('div');
                replyPreview.className = 'reply-preview';
                const originalSender = originalMessage.sender === 'me' ? 'You' : 'Emon';
                const originalText = (originalMessage.text || originalMessage.fileName || (originalMessage.mediaType === 'audio' ? 'Voice Message' : 'Media')).substring(0, 50);
                replyPreview.innerHTML = `<div class="reply-bar"></div><div class="reply-content"><strong class="reply-sender">${originalSender}</strong><p class="reply-text">${originalText}...</p></div>`;
                msgDiv.appendChild(replyPreview);
            }
        }
        if (messageData.mediaUrl) {
            if (messageData.mediaType === 'image') {
                const media = document.createElement('img');
                media.src = messageData.mediaUrl;
                media.classList.add('media');
                media.loading = 'lazy';
                media.alt = messageData.text || 'Image';
                media.onclick = (e) => { e.stopPropagation(); openImageModal(messageData.mediaUrl); };
                msgDiv.appendChild(media);
            } else if (messageData.mediaType === 'video') {
                const video = document.createElement('video');
                video.src = messageData.mediaUrl;
                video.classList.add('media-video');
                video.controls = true;
                video.playsinline = true;
                msgDiv.appendChild(video);
            } else if (messageData.mediaType === 'audio') {
                const audio = document.createElement('audio');
                audio.src = messageData.mediaUrl;
                audio.controls = true;
                audio.classList.add('media-audio');
                msgDiv.appendChild(audio);
            } else {
                const fileDiv = document.createElement('div');
                fileDiv.classList.add('file-message');
                fileDiv.innerHTML = `<i class="${getFileIcon(messageData.fileName || 'file')} file-icon"></i><div><div class="font-semibold text-white">${messageData.fileName || 'File'}</div><div class="text-xs text-gray-300">${messageData.fileSize ? formatFileSize(messageData.fileSize) : ''}</div></div>`;
                msgDiv.appendChild(fileDiv);
            }
            if (messageData.text) {
                const textDiv = document.createElement('div');
                textDiv.textContent = messageData.text;
                textDiv.classList.add('message-text-content');
                msgDiv.appendChild(textDiv);
            }
        } else if (messageData.text) {
            const textContent = document.createElement('p');
            textContent.textContent = messageData.text;
            textContent.className = 'message-text-content';
            msgDiv.appendChild(textContent);
        }
        const reactionsContainer = document.createElement('div');
        reactionsContainer.className = 'reactions-container';
        if (messageData.reactions && Object.keys(messageData.reactions).length > 0) {
            updateReactionsDisplay(reactionsContainer, messageData.reactions);
        }
        msgDiv.appendChild(reactionsContainer);
        const timeDiv = document.createElement('div');
        timeDiv.classList.add('message-time');
        const displayDate = new Date(messageData.timestamp);
        timeDiv.textContent = displayDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
        msgDiv.appendChild(timeDiv);
        msgDiv.addEventListener('click', (e) => { e.stopPropagation(); openMessageActionMenu(msgDiv); });
        if (prepend) {
            loadMoreBtn.insertAdjacentElement('afterend', msgDiv);
        } else {
            chatBox.appendChild(msgDiv);
        }
    }

    function addMessage(text, sender, mediaUrl = null, mediaType = 'image', fileName = null, fileSize = null, timestamp = Date.now(), replyToId = null, telegramMsgId = null) {
        const messageData = { text, sender, mediaUrl, mediaType, fileName, fileSize, timestamp, id: Date.now() + '' + Math.random(), reactions: {}, replyTo: replyToId, telegramMessageId: telegramMsgId };
        chatHistory.push(messageData);
        saveChatHistory();
        displayMessage(messageData);
        if (initialLoadComplete) {
            setTimeout(() => scrollToBottom(), 100);
        }
        return messageData;
    }

    function openMessageActionMenu(messageEl) {
        activeMessageElement = messageEl;
        messageActionMenu.classList.remove('hidden');
        const rect = messageEl.getBoundingClientRect();
        const menuHeight = messageActionMenu.offsetHeight;
        let top = rect.top - menuHeight - 10;
        let left = rect.left;
        if (messageEl.classList.contains('me')) {
            left = rect.right - messageActionMenu.offsetWidth;
        }
        if (top < 10) top = rect.bottom + 10;
        if (left < 10) left = 10;
        if (left + messageActionMenu.offsetWidth > window.innerWidth - 10) {
            left = window.innerWidth - messageActionMenu.offsetWidth - 10;
        }
        messageActionMenu.style.top = `${top}px`;
        messageActionMenu.style.left = `${left}px`;
    }

    function closeMessageActionMenu() {
        if (!messageActionMenu.classList.contains('hidden')) {
            messageActionMenu.classList.add('hidden');
            activeMessageElement = null;
        }
        expandedReactionsPanel.classList.remove('show');
        expandedReactionsPanel.classList.add('hidden');
        const expandBtn = document.getElementById('expandBtn');
        if (expandBtn) {
            expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
        }
    }

    function handleReaction(emoji) {
        if (!activeMessageElement) return;
        const messageId = activeMessageElement.dataset.messageId;
        const message = chatHistory.find(m => m.id == messageId);
        if (message) {
            if (message.reactions[emoji]) { 
                delete message.reactions[emoji]; 
            } else { 
                message.reactions[emoji] = 1;
                emojiUsage[emoji] = Date.now();
                saveEmojiUsage();
                populateReactions();
            }
            saveChatHistory();
            const reactionsContainer = activeMessageElement.querySelector('.reactions-container');
            updateReactionsDisplay(reactionsContainer, message.reactions);
            if (message.telegramMessageId) {
                const reactionPayload = Object.keys(message.reactions).map(em => ({ type: 'emoji', emoji: em }));
                fetch(`https://api.telegram.org/bot${TOKEN}/setMessageReaction`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        message_id: message.telegramMessageId,
                        reaction: reactionPayload.length > 0 ? JSON.stringify(reactionPayload) : '',
                    })
                });
            }
        }
        closeMessageActionMenu();
    }

    function updateReactionsDisplay(container, reactions) {
        container.innerHTML = Object.keys(reactions).map(emoji => `<span class="reaction-pill">${emoji}</span>`).join('');
        container.classList.toggle('visible', Object.keys(reactions).length > 0);
    }

    function copyMessageText() {
        if (!activeMessageElement) return;
        const textEl = activeMessageElement.querySelector('.message-text-content');
        if (textEl?.textContent) {
            navigator.clipboard.writeText(textEl.textContent).then(() => {
                showSentStatus('Message copied!');
            }, () => {
                showSentStatus('Failed to copy', 'error');
            });
        } else {
            showSentStatus('No text to copy', 'error');
        }
        closeMessageActionMenu();
    }

    function setupReply() {
        if (!activeMessageElement) return;
        const messageId = activeMessageElement.dataset.messageId;
        activeReplyMessage = chatHistory.find(m => m.id == messageId);
        if (activeReplyMessage) {
            replyingToUser.textContent = activeReplyMessage.sender === 'me' ? 'You' : 'Emon';
            const displayText = activeReplyMessage.text || (activeReplyMessage.mediaType === 'audio' ? 'Voice Message' : (activeReplyMessage.fileName || 'Media'));
            replyingToText.textContent = displayText.substring(0, 50) + (displayText.length > 50 ? '...' : '');
            replyingToBar.classList.add('show');
            messageInput.focus();
        }
        closeMessageActionMenu();
    }

    function cancelReply() {
        activeReplyMessage = null;
        replyingToBar.classList.remove('show');
    }

    function populateReactions() {
        const sortedReactions = [...allReactions].sort((a, b) => {
            return (emojiUsage[b] || 0) - (emojiUsage[a] || 0);
        });
        
        const topReactions = sortedReactions.slice(0, 5);

        quickReactions.innerHTML = topReactions.map(emoji =>
            `<button class="reaction-emoji" onclick="event.stopPropagation(); handleReaction('${emoji}')">${emoji}</button>`
        ).join('') + `
            <button class="expand-toggle-btn" onclick="event.stopPropagation(); toggleReactionExpand()" id="expandBtn">
                <i class="fas fa-chevron-down"></i>
            </button>
        `;

        expandedReactionsPanel.innerHTML = sortedReactions.map(emoji =>
            `<button class="reaction-emoji" onclick="event.stopPropagation(); handleReaction('${emoji}')">${emoji}</button>`
        ).join('');
    }

    function toggleReactionExpand() {
        const isExpanded = expandedReactionsPanel.classList.contains('show');
        const expandBtn = document.getElementById('expandBtn');

        if (isExpanded) {
            expandedReactionsPanel.classList.remove('show');
            expandedReactionsPanel.classList.add('hidden');
            expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
        } else {
            expandedReactionsPanel.classList.remove('hidden');
            expandedReactionsPanel.classList.add('show');
            expandBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        }
    }

    function deleteMessage() {
        if (!activeMessageElement) return;
        const elementToDelete = activeMessageElement;
        const messageId = elementToDelete.dataset.messageId;
        const messageIndex = chatHistory.findIndex(m => m.id == messageId);
        closeMessageActionMenu();
        if (messageIndex > -1) {
            const messageToDelete = chatHistory[messageIndex];
            const truncatedContent = (messageToDelete.text || messageToDelete.fileName || "Attachment").substring(0, 50);
            const notificationText = `"${truncatedContent}..." MESSAGE HAS BEEN DELETED`;
            fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: CHAT_ID, text: notificationText })
            });
            chatHistory.splice(messageIndex, 1);
            saveChatHistory();
            elementToDelete.style.transition = 'opacity 0.4s, transform 0.4s';
            elementToDelete.style.opacity = '0';
            elementToDelete.style.transform = 'translateX(20px) scale(0.9)';
            setTimeout(() => elementToDelete.remove(), 400);
            showSentStatus('Message removed from site!');
        }
    }

    function openImageModal(imageUrl) { fullImage.src = imageUrl; modalContainer.style.display = 'flex'; }
    function closeModal() { modalContainer.style.display = 'none'; }
    function scrollToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }
    function openFileDialog() { fileInput.click(); }

    async function sendMessage(textOverride = null) {
        const message = textOverride || messageInput.value.trim();
        const file = fileInput.files[0];
        if (file) { await sendFile(); return; }
        if (!message) return;

        const replyToId = activeReplyMessage ? activeReplyMessage.id : null;
        let fetchBody = { chat_id: CHAT_ID, text: message };
        if(activeReplyMessage && activeReplyMessage.telegramMessageId) {
            fetchBody.reply_parameters = { message_id: activeReplyMessage.telegramMessageId };
        }
        const sentMessageData = addMessage(message, 'me', null, null, null, null, Date.now(), replyToId);
        if(!textOverride) { messageInput.value = ''; autoResizeTextarea(); }
        cancelReply();
        try {
            const res = await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(fetchBody)
            });
            const data = await res.json();
            if (!data.ok) throw new Error(data.description);
            sentMessageData.telegramMessageId = data.result.message_id;
            saveChatHistory();
        } catch(err) {
            showSentStatus('Failed to send message', 'error');
        }
    }

    function autoResizeTextarea() {
        messageInput.style.height = 'auto';
        messageInput.style.height = `${Math.min(messageInput.scrollHeight, 128)}px`;
    }

    async function sendFile() {
        const file = fileInput.files[0];
        if (!file) { showSentStatus('No file selected!', 'error'); return; }
        const caption = messageInput.value.trim();
        const mediaType = file.type.startsWith('image/') ? 'image' : (file.type.startsWith('video/') ? 'video' : 'document');
        const replyToId = activeReplyMessage ? activeReplyMessage.id : null;
        const sentMessageData = addMessage(caption, 'me', URL.createObjectURL(file), mediaType, file.name, file.size, Date.now(), replyToId);
        cancelReply(); messageInput.value = ''; autoResizeTextarea();
        const formData = new FormData();
        formData.append("chat_id", CHAT_ID);
        if (activeReplyMessage && activeReplyMessage.telegramMessageId) {
            formData.append('reply_parameters', JSON.stringify({ message_id: activeReplyMessage.telegramMessageId }));
        }
        let endpoint = mediaType === 'image' ? 'sendPhoto' : (mediaType === 'video' ? 'sendVideo' : 'sendDocument');
        formData.append(endpoint.replace('send','').toLowerCase(), file);
        if (caption) formData.append('caption', caption);
        try {
            const res = await fetch(`https://api.telegram.org/bot${TOKEN}/${endpoint}`, { method: "POST", body: formData });
            const data = await res.json();
            if (!data.ok) throw new Error(data.description);
            sentMessageData.telegramMessageId = data.result.message_id;
            saveChatHistory();
        } catch(err) {
            showSentStatus('Upload failed', 'error');
        }
        clearFileSelection();
    }

    function updateSendButton() {
        sendBtn.disabled = !(messageInput.value.trim().length > 0 || fileInput.files.length > 0);
    }
    function clearFileSelection() {
        fileInput.value = '';
        fileInfoBar.classList.remove('show');
        updateSendButton();
    }

    // Recording Logic
    startRecBtn.addEventListener('click', async () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showSentStatus('Microphone not supported', 'error');
            return;
        }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = async () => {
                stream.getTracks().forEach(track => track.stop());
                if (shouldSendRecording) {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendVoiceMessage(audioBlob);
                }
            };
            
            mediaRecorder.start();
            showRecordingUI();
        } catch (err) {
            console.error(err);
            showSentStatus('Microphone access denied', 'error');
        }
    });

    function showRecordingUI() {
        recordingUI.classList.add('active');
        recordStartTime = Date.now();
        updateTimer();
        recordInterval = setInterval(updateTimer, 1000);
    }

    function hideRecordingUI() {
        recordingUI.classList.remove('active');
        clearInterval(recordInterval);
        recordTimer.textContent = "00:00";
    }

    function updateTimer() {
        const diff = Math.floor((Date.now() - recordStartTime) / 1000);
        const m = Math.floor(diff / 60).toString().padStart(2, '0');
        const s = (diff % 60).toString().padStart(2, '0');
        recordTimer.textContent = `${m}:${s}`;
    }

    cancelRecBtn.addEventListener('click', () => {
        shouldSendRecording = false;
        if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        hideRecordingUI();
    });

    sendRecBtn.addEventListener('click', () => {
        shouldSendRecording = true;
        if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        hideRecordingUI();
    });

    async function sendVoiceMessage(blob) {
        const url = URL.createObjectURL(blob);
        const replyToId = activeReplyMessage ? activeReplyMessage.id : null;
        const msgData = addMessage(null, 'me', url, 'audio', 'Voice Message', blob.size, Date.now(), replyToId);
        cancelReply();
        
        const formData = new FormData();
        formData.append("chat_id", CHAT_ID);
        if (activeReplyMessage && activeReplyMessage.telegramMessageId) {
            formData.append('reply_parameters', JSON.stringify({ message_id: activeReplyMessage.telegramMessageId }));
        }
        formData.append('voice', blob, 'voice.webm');
        
        try {
            const res = await fetch(`https://api.telegram.org/bot${TOKEN}/sendVoice`, { method: "POST", body: formData });
            const data = await res.json();
            if (!data.ok) throw new Error(data.description);
            msgData.telegramMessageId = data.result.message_id;
            saveChatHistory();
        } catch(err) {
            showSentStatus('Voice upload failed', 'error');
        }
    }

    let pollRetryDelay = 1000;
    const MAX_POLL_RETRY_DELAY = 30000;

    function pollMessages() {
        fetch(`https://api.telegram.org/bot${TOKEN}/getUpdates?offset=${lastUpdateId + 1}&timeout=25&allowed_updates=["message","message_reaction"]`)
            .then(res => res.ok ? res.json() : Promise.reject(new Error(res.statusText)))
            .then(data => {
                pollRetryDelay = 1000;
                if (data.ok && data.result.length > 0) {
                    data.result.forEach(update => {
                        lastUpdateId = update.update_id;
                        const msg = update.message;
                        const reaction = update.message_reaction;
                        if(msg && msg.from.id === EMON_ID) {
                            if (msg.text && msg.text.includes("MESSAGE HAS BEEN DELETED")) return;
                            const text = msg.text || msg.caption || '';
                            const time = msg.date * 1000;
                            const fileData = msg.photo?.pop() || msg.video || msg.document || msg.voice || msg.audio;
                            let replyToId = null;
                            if (msg.reply_to_message) {
                                const originalMessage = chatHistory.find(m => m.telegramMessageId === msg.reply_to_message.message_id);
                                if (originalMessage) replyToId = originalMessage.id;
                            }
                            if (fileData) {
                                fetch(`https://api.telegram.org/bot${TOKEN}/getFile?file_id=${fileData.file_id}`).then(res=>res.json()).then(fileInfo => {
                                    if (!fileInfo.ok) return;
                                    const url = `https://api.telegram.org/file/bot${TOKEN}/${fileInfo.result.file_path}`;
                                    const type = msg.photo ? 'image' : (msg.video ? 'video' : (msg.voice || msg.audio ? 'audio' : 'document'));
                                    addMessage(text, 'emon', url, type, fileData.file_name, fileData.file_size, time, replyToId, msg.message_id);
                                });
                            } else if (text) {
                                addMessage(text, 'emon', null, null, null, null, time, replyToId, msg.message_id);
                            }
                        }
                        if(reaction && reaction.user.id === EMON_ID) {
                            const message = chatHistory.find(m => m.telegramMessageId === reaction.message_id);
                            if (message) {
                                const newReactions = {};
                                reaction.new_reaction.forEach(r => { if(r.type === 'emoji') newReactions[r.emoji] = 1; });
                                message.reactions = newReactions;
                                saveChatHistory();
                                const messageEl = document.querySelector(`div[data-message-id='${message.id}']`);
                                if(messageEl) {
                                    const reactionsContainer = messageEl.querySelector('.reactions-container');
                                    updateReactionsDisplay(reactionsContainer, message.reactions);
                                }
                            }
                        }
                    });
                }
                pollMessages();
            })
            .catch(err => {
                console.error('Polling error:', err);
                setTimeout(pollMessages, pollRetryDelay);
                pollRetryDelay = Math.min(pollRetryDelay * 2, MAX_POLL_RETRY_DELAY);
            });
    }

    loadMoreBtn.addEventListener('click', loadOlderMessages);
    messageInput.addEventListener('input', () => { autoResizeTextarea(); updateSendButton(); });
    messageInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
            fileNameDisplay.textContent = file.name.length > 20 ? `${file.name.substring(0,18)}...` : file.name;
            fileSizeDisplay.textContent = formatFileSize(file.size);
            fileIconDisplay.className = `file-icon ${getFileIcon(file.name)}`;
            fileInfoBar.classList.add('show');
        } else {
            fileInfoBar.classList.remove('show');
        }
        updateSendButton();
    });
    fileCloseBtn.addEventListener('click', clearFileSelection);
    document.body.addEventListener('click', closeMessageActionMenu);
    replyBtn.addEventListener('click', (e) => { e.stopPropagation(); setupReply(); });
    copyBtn.addEventListener('click', (e) => { e.stopPropagation(); copyMessageText(); });
    deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteMessage(); });
    replyCloseBtn.addEventListener('click', cancelReply);

    loadEmojiUsage();
    populateReactions();
    loadChatHistory();
    pollMessages();
    updateSendButton();
</script>

</body>
</html>
